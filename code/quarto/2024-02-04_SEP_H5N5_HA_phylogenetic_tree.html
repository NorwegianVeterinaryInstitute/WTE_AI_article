<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Eve Zeyl Fiskebeck">
<meta name="dcterms.date" content="2024-02-04">

<title>SEP H5N5 Phylogenetic tree</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="SEP_H5N5_HA_phylogenetic_tree_files/libs/clipboard/clipboard.min.js"></script>
<script src="SEP_H5N5_HA_phylogenetic_tree_files/libs/quarto-html/quarto.js"></script>
<script src="SEP_H5N5_HA_phylogenetic_tree_files/libs/quarto-html/popper.min.js"></script>
<script src="SEP_H5N5_HA_phylogenetic_tree_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="SEP_H5N5_HA_phylogenetic_tree_files/libs/quarto-html/anchor.min.js"></script>
<link href="SEP_H5N5_HA_phylogenetic_tree_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="SEP_H5N5_HA_phylogenetic_tree_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="SEP_H5N5_HA_phylogenetic_tree_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="SEP_H5N5_HA_phylogenetic_tree_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="SEP_H5N5_HA_phylogenetic_tree_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">SEP H5N5 Phylogenetic tree</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Eve Zeyl Fiskebeck </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 4, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="setup" class="level1">
<h1>Setup</h1>
<ul>
<li>sourcing scripts and functions</li>
</ul>
<p>Note: if you are modifying the script and want to continue to work after, you can load a previous environment (don’t forget to save it at the end of your work).</p>
<p>Loads the environment (to continue previous work)</p>
</section>
<section id="preparation-of-metadata-specific-to-the-tree" class="level1">
<h1>Preparation of metadata specific to the tree</h1>
<p>This is the metadata that we combined to do all the trees, and where the host family has been added manually.</p>
<div class="cell">
<pre><code>#&gt; Rows: 5,129
#&gt; Columns: 28
#&gt; $ label                &lt;chr&gt; "EPI_ISL_1224989", "EPI_ISL_7267244", "EPI_ISL_11…
#&gt; $ Isolate_Id           &lt;chr&gt; "EPI_ISL_1224989", "EPI_ISL_7267244", "EPI_ISL_11…
#&gt; $ subtype              &lt;chr&gt; "H5N1", "H5N1", "H5N1", "H5N1", "H5N1", "H5N1", "…
#&gt; $ continent            &lt;chr&gt; "Europe", "Europe", "Europe", "Europe", "Europe",…
#&gt; $ country              &lt;chr&gt; "Netherlands", "Netherlands", "Denmark", "United …
#&gt; $ Host                 &lt;chr&gt; "Buteo buteo", "Buteo buteo", "Buteo buteo", "But…
#&gt; $ year                 &lt;int&gt; 2021, 2021, 2021, 2021, 2021, 2021, 2021, 2021, 2…
#&gt; $ month                &lt;int&gt; 2, 11, 10, 11, 11, 11, 12, 12, 1, 5, 11, 12, 12, …
#&gt; $ day                  &lt;int&gt; 1, 12, 25, 2, 20, 29, 15, 24, 9, 7, 25, 26, 27, 3…
#&gt; $ Locality             &lt;chr&gt; "NA", "NA", "NA", "NA", "NA", "NA", "NA", "NA", "…
#&gt; $ Locality_code        &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
#&gt; $ lon                  &lt;dbl&gt; 5.291266, 5.291266, 9.501785, -3.435973, -3.43597…
#&gt; $ lat                  &lt;dbl&gt; 52.13263, 52.13263, 56.26392, 55.37805, 55.37805,…
#&gt; $ Host_latin           &lt;chr&gt; "Buteo buteo", "Buteo buteo", "Buteo buteo", "But…
#&gt; $ precision_Host_latin &lt;chr&gt; "NA", "NA", "NA", "NA", "NA", "NA", "NA", "NA", "…
#&gt; $ comment              &lt;chr&gt; "NA", "NA", "NA", "NA", "NA", "NA", "NA", "NA", "…
#&gt; $ artkode              &lt;dbl&gt; 5080102009, 5080102009, 5080102009, 5080102009, 5…
#&gt; $ art                  &lt;chr&gt; "Musvåk", "Musvåk", "Musvåk", "Musvåk", "Musvåk",…
#&gt; $ efsakode             &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
#&gt; $ efsanavn             &lt;chr&gt; "Common Buzzard (as animal)", "Common Buzzard (as…
#&gt; $ norsk_navn           &lt;chr&gt; "Musvåk", "Musvåk", "Musvåk", "Musvåk", "Musvåk",…
#&gt; $ engelsk_navn         &lt;chr&gt; "Common Buzzard", "Common Buzzard", "Common Buzza…
#&gt; $ slekt                &lt;chr&gt; "Buteo", "Buteo", "Buteo", "Buteo", "Buteo", "But…
#&gt; $ familie              &lt;chr&gt; "Accipitridae", "Accipitridae", "Accipitridae", "…
#&gt; $ orden                &lt;chr&gt; "ACCIPITRIFORMES", "ACCIPITRIFORMES", "ACCIPITRIF…
#&gt; $ latinsk_navn         &lt;chr&gt; "NA", "NA", "NA", "NA", "NA", "NA", "NA", "NA", "…
#&gt; $ Host_family          &lt;chr&gt; "Accipitridae", "Accipitridae", "Accipitridae", "…
#&gt; $ Isolate_Name         &lt;chr&gt; "A/common buzzard/Netherlands/21022834-002/2021",…</code></pre>
</div>
<p>We select only the columns that we will use, to reduce complexity</p>
<p>Note in this script we do not have duplicate sequences, all tips represent themselves</p>
</section>
<section id="information" class="level1">
<h1>Information:</h1>
<p>For the purpose of homogeneization between plots, for the different phylogenetic trees, palettes and grouping helpers are defined in separate files which are sourced in this script.</p>
<ul>
<li>palettes are defined in the file <code>AI_palettes.R</code></li>
</ul>
</section>
<section id="importing-phylogenetic-tree-preparing-the-tree-and-metdata-for-plotting" class="level1">
<h1>Importing phylogenetic tree, preparing the tree and metdata for plotting</h1>
<section id="rooting-the-tree" class="level2">
<h2 class="anchored" data-anchor-id="rooting-the-tree">Rooting the tree</h2>
<ul>
<li><p>importing the tree and cleaning the tip labels (removing extension .fasta)</p></li>
<li><p>NB we used the consensus tree</p></li>
</ul>
<ul>
<li>fast plotting: we see that 2 very long branches, this are the outgroup sequences that we will use for rooting. We root those and remove them from the tree.</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SEP_H5N5_HA_phylogenetic_tree_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>rooting the tree, and dropping the two tips that correspond to the long branch</li>
</ul>
<p>Verification:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SEP_H5N5_HA_phylogenetic_tree_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="no-duplicate-sequences-to-integrate-in-this-tree" class="level2">
<h2 class="anchored" data-anchor-id="no-duplicate-sequences-to-integrate-in-this-tree">No duplicate sequences to integrate in this tree</h2>
<ul>
<li>creating table with metadata</li>
</ul>
<ul>
<li>recheck that we only have the correct subtypes included</li>
</ul>
<div class="cell">
<pre><code>#&gt; # A tibble: 2 × 2
#&gt;   subtype     n
#&gt;   &lt;chr&gt;   &lt;int&gt;
#&gt; 1 H5N1        1
#&gt; 2 H5N5       84</code></pre>
</div>
<p>This is ok that we have one H5N1 as its the reference/root</p>
<p>Adding filtering columns. We want to show where Norwegian sequences are,</p>
<p>For this purpose, we add columns that would allow to tag labels representing isolates from Norway, and those that contain White-tailed Eagles.</p>
<blockquote class="blockquote">
<p>Note here could have been simpler, but do as the same script as possible as H5N1_HA</p>
</blockquote>
</section>
<section id="exploration-of-the-phylogenetic-tree" class="level2">
<h2 class="anchored" data-anchor-id="exploration-of-the-phylogenetic-tree">Exploration of the phylogenetic tree</h2>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SEP_H5N5_HA_phylogenetic_tree_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- we do not collapse nodes for this tree -->
<div class="cell">
<pre><code>#&gt; Creating bootstrap field and names for nodes
#&gt; creating a simple plot
#&gt; merging bootstrap to plot data
#&gt; results are a list of a simple_plot and a tree with labelled nodes
#&gt; filtering the tree plot data to get only nodes
#&gt; checking if groups are monophyletic - without bootstrap support
#&gt; checking if groups are monophyletic - with bootstrap support
#&gt; adding edge data for plotting
#&gt; updating tree plot data and output
#&gt; Joining with `by = join_by(parent, node, branch.length, label, isTip, x, y,
#&gt; branch, angle, labels_bootstrap, node_depth)`
#&gt; Joining with `by = join_by(parent, node)`
#&gt; Returning the plot with the updated metadata. The tree with added node labels
#&gt; is in .$trees_nodeslab, and the simple plot is in .$simple_plot</code></pre>
</div>
<ul>
<li>exploring the structure</li>
</ul>
<div class="cell">
<pre><code>#&gt; List of 2
#&gt;  $ simple_plot :List of 9
#&gt;   ..$ data       : tbl_tree [167 × 15] (S3: tbl_tree/tbl_tree/tbl_df/tbl/data.frame)
#&gt;   .. ..- attr(*, "layout")= chr "rectangular"
#&gt;   ..$ layers     :List of 2
#&gt;   .. ..$ :Classes 'LayerInstance', 'Layer', 'ggproto', 'gg' &lt;ggproto object: Class LayerInstance, Layer, gg&gt;
#&gt;     aes_params: list
#&gt;     compute_aesthetics: function
#&gt;     compute_geom_1: function
#&gt;     compute_geom_2: function
#&gt;     compute_position: function
#&gt;     compute_statistic: function
#&gt;     computed_geom_params: NULL
#&gt;     computed_mapping: NULL
#&gt;     computed_stat_params: NULL
#&gt;     constructor: call
#&gt;     data: waiver
#&gt;     draw_geom: function
#&gt;     finish_statistics: function
#&gt;     geom: &lt;ggproto object: Class GeomSegment, Geom, gg&gt;
#&gt;         aesthetics: function
#&gt;         default_aes: uneval
#&gt;         draw_group: function
#&gt;         draw_key: function
#&gt;         draw_layer: function
#&gt;         draw_panel: function
#&gt;         extra_params: na.rm
#&gt;         handle_na: function
#&gt;         non_missing_aes: linetype linewidth shape
#&gt;         optional_aes: 
#&gt;         parameters: function
#&gt;         rename_size: TRUE
#&gt;         required_aes: x y xend yend
#&gt;         setup_data: function
#&gt;         setup_params: function
#&gt;         use_defaults: function
#&gt;         super:  &lt;ggproto object: Class Geom, gg&gt;
#&gt;     geom_params: list
#&gt;     inherit.aes: TRUE
#&gt;     layer_data: function
#&gt;     map_statistic: function
#&gt;     mapping: uneval
#&gt;     position: &lt;ggproto object: Class PositionIdentity, Position, gg&gt;
#&gt;         compute_layer: function
#&gt;         compute_panel: function
#&gt;         required_aes: 
#&gt;         setup_data: function
#&gt;         setup_params: function
#&gt;         super:  &lt;ggproto object: Class Position, gg&gt;
#&gt;     print: function
#&gt;     setup_layer: function
#&gt;     show.legend: NA
#&gt;     stat: &lt;ggproto object: Class StatTreeHorizontal, Stat, gg&gt;
#&gt;         aesthetics: function
#&gt;         compute_group: function
#&gt;         compute_layer: function
#&gt;         compute_panel: function
#&gt;         default_aes: uneval
#&gt;         dropped_aes: 
#&gt;         extra_params: na.rm
#&gt;         finish_layer: function
#&gt;         non_missing_aes: 
#&gt;         optional_aes: 
#&gt;         parameters: function
#&gt;         required_aes: node parent x y
#&gt;         retransform: TRUE
#&gt;         setup_data: function
#&gt;         setup_params: function
#&gt;         super:  &lt;ggproto object: Class Stat, gg&gt;
#&gt;     stat_params: list
#&gt;     super:  &lt;ggproto object: Class Layer, gg&gt; 
#&gt;   .. ..$ :Classes 'LayerInstance', 'Layer', 'ggproto', 'gg' &lt;ggproto object: Class LayerInstance, Layer, gg&gt;
#&gt;     aes_params: list
#&gt;     compute_aesthetics: function
#&gt;     compute_geom_1: function
#&gt;     compute_geom_2: function
#&gt;     compute_position: function
#&gt;     compute_statistic: function
#&gt;     computed_geom_params: NULL
#&gt;     computed_mapping: NULL
#&gt;     computed_stat_params: NULL
#&gt;     constructor: call
#&gt;     data: waiver
#&gt;     draw_geom: function
#&gt;     finish_statistics: function
#&gt;     geom: &lt;ggproto object: Class GeomSegment, Geom, gg&gt;
#&gt;         aesthetics: function
#&gt;         default_aes: uneval
#&gt;         draw_group: function
#&gt;         draw_key: function
#&gt;         draw_layer: function
#&gt;         draw_panel: function
#&gt;         extra_params: na.rm
#&gt;         handle_na: function
#&gt;         non_missing_aes: linetype linewidth shape
#&gt;         optional_aes: 
#&gt;         parameters: function
#&gt;         rename_size: TRUE
#&gt;         required_aes: x y xend yend
#&gt;         setup_data: function
#&gt;         setup_params: function
#&gt;         use_defaults: function
#&gt;         super:  &lt;ggproto object: Class Geom, gg&gt;
#&gt;     geom_params: list
#&gt;     inherit.aes: TRUE
#&gt;     layer_data: function
#&gt;     map_statistic: function
#&gt;     mapping: uneval
#&gt;     position: &lt;ggproto object: Class PositionIdentity, Position, gg&gt;
#&gt;         compute_layer: function
#&gt;         compute_panel: function
#&gt;         required_aes: 
#&gt;         setup_data: function
#&gt;         setup_params: function
#&gt;         super:  &lt;ggproto object: Class Position, gg&gt;
#&gt;     print: function
#&gt;     setup_layer: function
#&gt;     show.legend: NA
#&gt;     stat: &lt;ggproto object: Class StatTreeVertical, Stat, gg&gt;
#&gt;         aesthetics: function
#&gt;         compute_group: function
#&gt;         compute_layer: function
#&gt;         compute_panel: function
#&gt;         default_aes: uneval
#&gt;         dropped_aes: 
#&gt;         extra_params: na.rm
#&gt;         finish_layer: function
#&gt;         non_missing_aes: 
#&gt;         optional_aes: 
#&gt;         parameters: function
#&gt;         required_aes: node parent x y
#&gt;         retransform: TRUE
#&gt;         setup_data: function
#&gt;         setup_params: function
#&gt;         super:  &lt;ggproto object: Class Stat, gg&gt;
#&gt;     stat_params: list
#&gt;     super:  &lt;ggproto object: Class Layer, gg&gt; 
#&gt;   ..$ scales     :Classes 'ScalesList', 'ggproto', 'gg' &lt;ggproto object: Class ScalesList, gg&gt;
#&gt;     add: function
#&gt;     clone: function
#&gt;     find: function
#&gt;     get_scales: function
#&gt;     has_scale: function
#&gt;     input: function
#&gt;     n: function
#&gt;     non_position_scales: function
#&gt;     scales: list
#&gt;     super:  &lt;ggproto object: Class ScalesList, gg&gt; 
#&gt;   ..$ mapping    :List of 2
#&gt;   .. ..$ x: language ~x
#&gt;   .. .. ..- attr(*, ".Environment")=&lt;environment: 0x00000195310fed58&gt; 
#&gt;   .. ..$ y: language ~y
#&gt;   .. .. ..- attr(*, ".Environment")=&lt;environment: 0x00000195310fed58&gt; 
#&gt;   .. ..- attr(*, "class")= chr "uneval"
#&gt;   ..$ theme      :List of 97
#&gt;   .. ..$ line                      :List of 6
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_line" "element"
#&gt;   .. ..$ rect                      :List of 5
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_rect" "element"
#&gt;   .. ..$ text                      :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ title                     : NULL
#&gt;   .. ..$ aspect.ratio              : NULL
#&gt;   .. ..$ axis.title                : NULL
#&gt;   .. ..$ axis.title.x              :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ axis.title.x.top          :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ axis.title.x.bottom       : NULL
#&gt;   .. ..$ axis.title.y              :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ axis.title.y.left         : NULL
#&gt;   .. ..$ axis.title.y.right        :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ axis.text                 :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ axis.text.x               : list()
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_blank" "element"
#&gt;   .. ..$ axis.text.x.top           :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ axis.text.x.bottom        : NULL
#&gt;   .. ..$ axis.text.y               : list()
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_blank" "element"
#&gt;   .. ..$ axis.text.y.left          : NULL
#&gt;   .. ..$ axis.text.y.right         :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ axis.ticks                :List of 6
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_line" "element"
#&gt;   .. ..$ axis.ticks.x              : list()
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_blank" "element"
#&gt;   .. ..$ axis.ticks.x.top          : NULL
#&gt;   .. ..$ axis.ticks.x.bottom       : NULL
#&gt;   .. ..$ axis.ticks.y              : list()
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_blank" "element"
#&gt;   .. ..$ axis.ticks.y.left         : NULL
#&gt;   .. ..$ axis.ticks.y.right        : NULL
#&gt;   .. ..$ axis.ticks.length         : 'simpleUnit' num 2.75points
#&gt;   .. .. ..- attr(*, "unit")= int 8
#&gt;   .. ..$ axis.ticks.length.x       : NULL
#&gt;   .. ..$ axis.ticks.length.x.top   : NULL
#&gt;   .. ..$ axis.ticks.length.x.bottom: NULL
#&gt;   .. ..$ axis.ticks.length.y       : NULL
#&gt;   .. ..$ axis.ticks.length.y.left  : NULL
#&gt;   .. ..$ axis.ticks.length.y.right : NULL
#&gt;   .. ..$ axis.line                 :List of 6
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_line" "element"
#&gt;   .. ..$ axis.line.x               : list()
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_blank" "element"
#&gt;   .. ..$ axis.line.x.top           : NULL
#&gt;   .. ..$ axis.line.x.bottom        : NULL
#&gt;   .. ..$ axis.line.y               : list()
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_blank" "element"
#&gt;   .. ..$ axis.line.y.left          : NULL
#&gt;   .. ..$ axis.line.y.right         : NULL
#&gt;   .. ..$ legend.background         :List of 5
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_rect" "element"
#&gt;   .. ..$ legend.margin             : 'margin' num [1:4] 5.5points 5.5points 5.5points 5.5points
#&gt;   .. .. ..- attr(*, "unit")= int 8
#&gt;   .. ..$ legend.spacing            : 'simpleUnit' num 11points
#&gt;   .. .. ..- attr(*, "unit")= int 8
#&gt;   .. ..$ legend.spacing.x          : NULL
#&gt;   .. ..$ legend.spacing.y          : NULL
#&gt;   .. ..$ legend.key                :List of 5
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_rect" "element"
#&gt;   .. ..$ legend.key.size           : 'simpleUnit' num 1.2lines
#&gt;   .. .. ..- attr(*, "unit")= int 3
#&gt;   .. ..$ legend.key.height         : NULL
#&gt;   .. ..$ legend.key.width          : NULL
#&gt;   .. ..$ legend.text               :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ legend.text.align         : NULL
#&gt;   .. ..$ legend.title              :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ legend.title.align        : NULL
#&gt;   .. ..$ legend.position           : chr "right"
#&gt;   .. ..$ legend.direction          : NULL
#&gt;   .. ..$ legend.justification      : chr "center"
#&gt;   .. ..$ legend.box                : NULL
#&gt;   .. ..$ legend.box.just           : NULL
#&gt;   .. ..$ legend.box.margin         : 'margin' num [1:4] 0cm 0cm 0cm 0cm
#&gt;   .. .. ..- attr(*, "unit")= int 1
#&gt;   .. ..$ legend.box.background     : list()
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_blank" "element"
#&gt;   .. ..$ legend.box.spacing        : 'simpleUnit' num 11points
#&gt;   .. .. ..- attr(*, "unit")= int 8
#&gt;   .. ..$ panel.background          :List of 5
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_rect" "element"
#&gt;   .. ..$ panel.border              : list()
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_blank" "element"
#&gt;   .. ..$ panel.spacing             : 'simpleUnit' num 5.5points
#&gt;   .. .. ..- attr(*, "unit")= int 8
#&gt;   .. ..$ panel.spacing.x           : NULL
#&gt;   .. ..$ panel.spacing.y           : NULL
#&gt;   .. ..$ panel.grid                :List of 6
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_line" "element"
#&gt;   .. ..$ panel.grid.major          : list()
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_blank" "element"
#&gt;   .. ..$ panel.grid.minor          : list()
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_blank" "element"
#&gt;   .. ..$ panel.grid.major.x        : NULL
#&gt;   .. ..$ panel.grid.major.y        : NULL
#&gt;   .. ..$ panel.grid.minor.x        : NULL
#&gt;   .. ..$ panel.grid.minor.y        : NULL
#&gt;   .. ..$ panel.ontop               : logi FALSE
#&gt;   .. ..$ plot.background           :List of 5
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_rect" "element"
#&gt;   .. ..$ plot.title                :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ plot.title.position       : chr "panel"
#&gt;   .. ..$ plot.subtitle             :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ plot.caption              :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ plot.caption.position     : chr "panel"
#&gt;   .. ..$ plot.tag                  :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ plot.tag.position         : chr "topleft"
#&gt;   .. ..$ plot.margin               : 'margin' num [1:4] 5.5points 5.5points 5.5points 5.5points
#&gt;   .. .. ..- attr(*, "unit")= int 8
#&gt;   .. ..$ strip.background          :List of 5
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_rect" "element"
#&gt;   .. ..$ strip.background.x        : NULL
#&gt;   .. ..$ strip.background.y        : NULL
#&gt;   .. ..$ strip.clip                : chr "inherit"
#&gt;   .. ..$ strip.placement           : chr "inside"
#&gt;   .. ..$ strip.text                :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ strip.text.x              : NULL
#&gt;   .. ..$ strip.text.x.bottom       : NULL
#&gt;   .. ..$ strip.text.x.top          : NULL
#&gt;   .. ..$ strip.text.y              :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ strip.text.y.left         :List of 11
#&gt;   .. .. ..- attr(*, "class")= chr [1:2] "element_text" "element"
#&gt;   .. ..$ strip.text.y.right        : NULL
#&gt;   .. ..$ strip.switch.pad.grid     : 'simpleUnit' num 2.75points
#&gt;   .. .. ..- attr(*, "unit")= int 8
#&gt;   .. ..$ strip.switch.pad.wrap     : 'simpleUnit' num 2.75points
#&gt;   .. .. ..- attr(*, "unit")= int 8
#&gt;   .. ..- attr(*, "class")= chr [1:2] "theme" "gg"
#&gt;   .. ..- attr(*, "complete")= logi TRUE
#&gt;   .. ..- attr(*, "validate")= logi TRUE
#&gt;   ..$ coordinates:Classes 'CoordCartesian', 'Coord', 'ggproto', 'gg' &lt;ggproto object: Class CoordCartesian, Coord, gg&gt;
#&gt;     aspect: function
#&gt;     backtransform_range: function
#&gt;     clip: on
#&gt;     default: TRUE
#&gt;     distance: function
#&gt;     expand: TRUE
#&gt;     is_free: function
#&gt;     is_linear: function
#&gt;     labels: function
#&gt;     limits: list
#&gt;     modify_scales: function
#&gt;     range: function
#&gt;     render_axis_h: function
#&gt;     render_axis_v: function
#&gt;     render_bg: function
#&gt;     render_fg: function
#&gt;     setup_data: function
#&gt;     setup_layout: function
#&gt;     setup_panel_guides: function
#&gt;     setup_panel_params: function
#&gt;     setup_params: function
#&gt;     train_panel_guides: function
#&gt;     transform: function
#&gt;     super:  &lt;ggproto object: Class CoordCartesian, Coord, gg&gt; 
#&gt;   ..$ facet      :Classes 'FacetNull', 'Facet', 'ggproto', 'gg' &lt;ggproto object: Class FacetNull, Facet, gg&gt;
#&gt;     compute_layout: function
#&gt;     draw_back: function
#&gt;     draw_front: function
#&gt;     draw_labels: function
#&gt;     draw_panels: function
#&gt;     finish_data: function
#&gt;     init_scales: function
#&gt;     map_data: function
#&gt;     params: list
#&gt;     setup_data: function
#&gt;     setup_params: function
#&gt;     shrink: TRUE
#&gt;     train_scales: function
#&gt;     vars: function
#&gt;     super:  &lt;ggproto object: Class FacetNull, Facet, gg&gt; 
#&gt;   ..$ plot_env   :&lt;environment: 0x00000195310fed58&gt; 
#&gt;   ..$ labels     :List of 4
#&gt;   .. ..$ y     : NULL
#&gt;   .. ..$ x     : NULL
#&gt;   .. ..$ node  : chr "node"
#&gt;   .. ..$ parent: chr "parent"
#&gt;   ..- attr(*, "class")= chr [1:3] "ggtree" "gg" "ggplot"
#&gt;  $ tree_nodelab:List of 5
#&gt;   ..$ edge       : int [1:166, 1:2] 85 86 87 88 89 90 91 92 93 94 ...
#&gt;   ..$ edge.length: num [1:166] 6.82e-04 2.14e-06 2.14e-06 1.18e-03 1.78e-03 ...
#&gt;   ..$ Nnode      : int 83
#&gt;   ..$ node.label : chr [1:83] "N1" "N2" "N3" "N4" ...
#&gt;   ..$ tip.label  : chr [1:84] "EPI_ISL_18455200" "2022_07_1233_1" "2022_07_1141_1" "2022_07_446" ...
#&gt;   ..- attr(*, "class")= chr "phylo"
#&gt;   ..- attr(*, "order")= chr "cladewise"</code></pre>
</div>
<ul>
<li>saving in individual objects (copy). We will reuse the plot data</li>
</ul>
<div class="cell">
<pre><code>#&gt; # A tibble: 83 × 15
#&gt;    parent  node branch.length label isTip        x     y   branch angle
#&gt;     &lt;int&gt; &lt;int&gt;         &lt;dbl&gt; &lt;chr&gt; &lt;lgl&gt;    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;
#&gt;  1     85    85    0          N1    FALSE 0         12.2 0         52.4
#&gt;  2     85    86    0.000682   N2    FALSE 0.000682  23.4 0.000341 100. 
#&gt;  3     86    87    0.00000214 N3    FALSE 0.000684  39.7 0.000683 170. 
#&gt;  4     87    88    0.00000214 N4    FALSE 0.000686  42.9 0.000685 184. 
#&gt;  5     88    89    0.00118    N5    FALSE 0.00187   47.9 0.00128  205. 
#&gt;  6     89    90    0.00178    N6    FALSE 0.00364   54.0 0.00275  232. 
#&gt;  7     90    91    0.000990   N7    FALSE 0.00463   57.2 0.00414  245. 
#&gt;  8     91    92    0.000489   N8    FALSE 0.00512   60.3 0.00488  259. 
#&gt;  9     92    93    0.00148    N9    FALSE 0.00660   65.6 0.00586  281. 
#&gt; 10     93    94    0.000587   N10   FALSE 0.00718   73.1 0.00689  313. 
#&gt;    labels_bootstrap node_depth descendants_tips_from_node isMono_noboot isMono
#&gt;    &lt;chr&gt;                 &lt;dbl&gt; &lt;list&gt;                     &lt;lgl&gt;         &lt;lgl&gt; 
#&gt;  1 ""                       84 &lt;chr [84]&gt;                 TRUE          NA    
#&gt;  2 "82"                     83 &lt;chr [83]&gt;                 TRUE          FALSE 
#&gt;  3 "19"                     49 &lt;chr [49]&gt;                 TRUE          FALSE 
#&gt;  4 "38"                     47 &lt;chr [47]&gt;                 TRUE          FALSE 
#&gt;  5 "94"                     46 &lt;chr [46]&gt;                 TRUE          FALSE 
#&gt;  6 "96"                     35 &lt;chr [35]&gt;                 TRUE          TRUE  
#&gt;  7 "87"                     31 &lt;chr [31]&gt;                 TRUE          FALSE 
#&gt;  8 "87"                     30 &lt;chr [30]&gt;                 TRUE          FALSE 
#&gt;  9 "85"                     29 &lt;chr [29]&gt;                 TRUE          FALSE 
#&gt; 10 "82"                     15 &lt;chr [15]&gt;                 TRUE          FALSE 
#&gt;    edge_num
#&gt;       &lt;int&gt;
#&gt;  1       NA
#&gt;  2        1
#&gt;  3        2
#&gt;  4        3
#&gt;  5        4
#&gt;  6        5
#&gt;  7        6
#&gt;  8        7
#&gt;  9        8
#&gt; 10        9
#&gt; # ℹ 73 more rows</code></pre>
</div>
<p>Checking data - ok it has nested the descendants from nodes</p>
<div class="cell">
<pre><code>#&gt; # A tibble: 84 × 1
#&gt;    descendants_tips_from_node
#&gt;    &lt;chr&gt;                     
#&gt;  1 EPI_ISL_1123358           
#&gt;  2 EPI_ISL_644737            
#&gt;  3 EPI_ISL_12028892          
#&gt;  4 2022_04_13257_1           
#&gt;  5 2022_07_1140_1            
#&gt;  6 2022_07_1141_1            
#&gt;  7 EPI_ISL_18455200          
#&gt;  8 2022_07_1233_1            
#&gt;  9 2022_07_446               
#&gt; 10 2022_07_693_1             
#&gt; # ℹ 74 more rows</code></pre>
</div>
<section id="adding-metadata-to-nodes-and-tips" class="level3">
<h3 class="anchored" data-anchor-id="adding-metadata-to-nodes-and-tips">2. Adding metadata to nodes and tips</h3>
<blockquote class="blockquote">
<p>for consistency with previous script - we also add tipmetalink</p>
</blockquote>
<ul>
<li>linking metadata to the tree data for the selected column by creating nested dataframes for each variable and creating contingency tables for each nested variable</li>
</ul>
<p>We create contingency tables and nested variables that represent the metadata for each node and tip (label column).</p>
<p>Note here, we come back to the original metadata table, because we have the list of tips that is represented at each label (tip or node)</p>
<p>Here we do not want to use interaction between factors</p>
<p>Here is how it looks like</p>
<div class="cell">
<pre><code>#&gt;  [1] "parent"                     "node"                      
#&gt;  [3] "branch.length"              "label"                     
#&gt;  [5] "isTip"                      "x"                         
#&gt;  [7] "y"                          "branch"                    
#&gt;  [9] "angle"                      "labels_bootstrap"          
#&gt; [11] "node_depth"                 "descendants_tips_from_node"
#&gt; [13] "isMono_noboot"              "isMono"                    
#&gt; [15] "edge_num"                   "tip_metalink"              
#&gt; [17] "nested_country"             "ctg_country"               
#&gt; [19] "nested_Host"                "ctg_Host"                  
#&gt; [21] "nested_Host_latin"          "ctg_Host_latin"            
#&gt; [23] "nested_year"                "ctg_year"                  
#&gt; [25] "nested_continent"           "ctg_continent"             
#&gt; [27] "nested_Host_family"         "ctg_Host_family"</code></pre>
</div>
<div class="cell">
<pre><code>#&gt; # A tibble: 167 × 28
#&gt; # Rowwise: 
#&gt;    parent  node branch.length label            isTip       x     y  branch angle
#&gt;     &lt;int&gt; &lt;int&gt;         &lt;dbl&gt; &lt;chr&gt;            &lt;lgl&gt;   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;
#&gt;  1    101     1    0          EPI_ISL_18455200 TRUE  0.00837    83 0.00837  356.
#&gt;  2    101     2    0          2022_07_1233_1   TRUE  0.00837    84 0.00837  360 
#&gt;  3    100     3    0.00000214 2022_07_1141_1   TRUE  0.00837    82 0.00837  351.
#&gt;  4    102     4    0.00000214 2022_07_446      TRUE  0.00837    80 0.00837  343.
#&gt;  5    102     5    0.00000214 2022_07_693_1    TRUE  0.00837    81 0.00837  347.
#&gt;  6     98     6    0.000587   2022_07_1140_1   TRUE  0.00895    79 0.00865  339.
#&gt;  7    103     7    0.00000214 2022_07_448      TRUE  0.00836    77 0.00836  330 
#&gt;  8    103     8    0.00000214 2022_07_981_1    TRUE  0.00836    78 0.00836  334.
#&gt;  9    104     9    0.00000214 2022_07_1137_1   TRUE  0.00778    75 0.00778  321.
#&gt; 10    104    10    0.00000214 2022_07_895_1    TRUE  0.00778    76 0.00778  326.
#&gt;    labels_bootstrap node_depth descendants_tips_from_node isMono_noboot isMono
#&gt;    &lt;chr&gt;                 &lt;dbl&gt; &lt;list&gt;                     &lt;lgl&gt;         &lt;lgl&gt; 
#&gt;  1 EPI_ISL_18455200          1 &lt;NULL&gt;                     NA            NA    
#&gt;  2 2022_07_1233_1            1 &lt;NULL&gt;                     NA            NA    
#&gt;  3 2022_07_1141_1            1 &lt;NULL&gt;                     NA            NA    
#&gt;  4 2022_07_446               1 &lt;NULL&gt;                     NA            NA    
#&gt;  5 2022_07_693_1             1 &lt;NULL&gt;                     NA            NA    
#&gt;  6 2022_07_1140_1            1 &lt;NULL&gt;                     NA            NA    
#&gt;  7 2022_07_448               1 &lt;NULL&gt;                     NA            NA    
#&gt;  8 2022_07_981_1             1 &lt;NULL&gt;                     NA            NA    
#&gt;  9 2022_07_1137_1            1 &lt;NULL&gt;                     NA            NA    
#&gt; 10 2022_07_895_1             1 &lt;NULL&gt;                     NA            NA    
#&gt;    edge_num tip_metalink nested_country   ctg_country      nested_Host     
#&gt;       &lt;int&gt; &lt;list&gt;       &lt;list&gt;           &lt;list&gt;           &lt;list&gt;          
#&gt;  1       17 &lt;chr [1]&gt;    &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  2       18 &lt;chr [1]&gt;    &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  3       19 &lt;chr [1]&gt;    &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  4       21 &lt;chr [1]&gt;    &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  5       22 &lt;chr [1]&gt;    &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  6       23 &lt;chr [1]&gt;    &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  7       25 &lt;chr [1]&gt;    &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  8       26 &lt;chr [1]&gt;    &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  9       28 &lt;chr [1]&gt;    &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt; 10       29 &lt;chr [1]&gt;    &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;    ctg_Host         nested_Host_latin ctg_Host_latin   nested_year     
#&gt;    &lt;list&gt;           &lt;list&gt;            &lt;list&gt;           &lt;list&gt;          
#&gt;  1 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  2 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  3 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  4 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  5 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  6 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  7 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  8 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;  9 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt; 10 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;
#&gt;    ctg_year         nested_continent ctg_continent    nested_Host_family
#&gt;    &lt;list&gt;           &lt;list&gt;           &lt;list&gt;           &lt;list&gt;            
#&gt;  1 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  
#&gt;  2 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  
#&gt;  3 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  
#&gt;  4 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  
#&gt;  5 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  
#&gt;  6 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  
#&gt;  7 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  
#&gt;  8 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  
#&gt;  9 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  
#&gt; 10 &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt; &lt;tibble [1 × 4]&gt; &lt;tibble [1 × 3]&gt;  
#&gt;    ctg_Host_family 
#&gt;    &lt;list&gt;          
#&gt;  1 &lt;tibble [1 × 4]&gt;
#&gt;  2 &lt;tibble [1 × 4]&gt;
#&gt;  3 &lt;tibble [1 × 4]&gt;
#&gt;  4 &lt;tibble [1 × 4]&gt;
#&gt;  5 &lt;tibble [1 × 4]&gt;
#&gt;  6 &lt;tibble [1 × 4]&gt;
#&gt;  7 &lt;tibble [1 × 4]&gt;
#&gt;  8 &lt;tibble [1 × 4]&gt;
#&gt;  9 &lt;tibble [1 × 4]&gt;
#&gt; 10 &lt;tibble [1 × 4]&gt;
#&gt; # ℹ 157 more rows</code></pre>
</div>
<p>Selecting one column where several tips are respresented and showing an example of how the nested variable looks like, using eg. nested country variable</p>
<blockquote class="blockquote">
<p>note for this data set its only nodes</p>
</blockquote>
<div class="cell">
<pre><code>#&gt; # A tibble: 84 × 3
#&gt;    label            country          pos
#&gt;    &lt;chr&gt;            &lt;chr&gt;          &lt;int&gt;
#&gt;  1 EPI_ISL_1123358  United Kingdom     1
#&gt;  2 EPI_ISL_644737   Denmark            2
#&gt;  3 EPI_ISL_12028892 Norway             3
#&gt;  4 2022_04_13257_1  Norway             4
#&gt;  5 2022_07_1140_1   Norway             5
#&gt;  6 2022_07_1141_1   Norway             6
#&gt;  7 EPI_ISL_18455200 Norway             7
#&gt;  8 2022_07_1233_1   Norway             8
#&gt;  9 2022_07_446      Norway             9
#&gt; 10 2022_07_693_1    Norway            10
#&gt; # ℹ 74 more rows</code></pre>
</div>
<p><code>pos</code> is the index, in case we need to refer to it. <code>label</code> is the label of the sequences that are represented</p>
<p>Now we can look at the contingency table for the same variable</p>
<div class="cell">
<pre><code>#&gt; # A tibble: 17 × 4
#&gt;    country            `freq_levels@country` `nb_levels@country`   pos
#&gt;    &lt;chr&gt;                              &lt;int&gt;               &lt;int&gt; &lt;int&gt;
#&gt;  1 United Kingdom                         3                  17     1
#&gt;  2 Denmark                                1                  17     2
#&gt;  3 Norway                                31                  17     3
#&gt;  4 Russian Federation                     9                  17     4
#&gt;  5 Romania                                8                  17     5
#&gt;  6 Bulgaria                               2                  17     6
#&gt;  7 Poland                                 1                  17     7
#&gt;  8 Italy                                  1                  17     8
#&gt;  9 Germany                                2                  17     9
#&gt; 10 Slovenia                               1                  17    10
#&gt; 11 Sweden                                17                  17    11
#&gt; 12 Netherlands                            1                  17    12
#&gt; 13 Belgium                                1                  17    13
#&gt; 14 Slovakia                               3                  17    14
#&gt; 15 Hungary                                1                  17    15
#&gt; 16 Austria                                1                  17    16
#&gt; 17 Czech Republic                         1                  17    17</code></pre>
</div>
<p><code>freq_levels@country</code> : is the number of observations in each country <code>nb_levels@country</code> : is common in the nested table, its the number of levels of the variable country</p>
<ul>
<li>NOW: we can reinsert the augmented data to the plot</li>
</ul>
</section>
<section id="filtering-based-on-criteria-based-on-information-from-nested-metadata" class="level3">
<h3 class="anchored" data-anchor-id="filtering-based-on-criteria-based-on-information-from-nested-metadata">3. Filtering based on criteria based on information from nested metadata</h3>
<ul>
<li>Filtering based on criteria that are found in the nested metadata that is attached to the tree plot_data</li>
</ul>
<p>We add a tag - if there is at least one isolate that is represented by a label in the phylogenetic tree has been collected in Norway</p>
<div class="cell">
<pre><code>#&gt;  [1] "parent"                     "node"                      
#&gt;  [3] "branch.length"              "label"                     
#&gt;  [5] "isTip"                      "x"                         
#&gt;  [7] "y"                          "branch"                    
#&gt;  [9] "angle"                      "labels_bootstrap"          
#&gt; [11] "node_depth"                 "descendants_tips_from_node"
#&gt; [13] "isMono_noboot"              "isMono"                    
#&gt; [15] "edge_num"                   "tip_metalink"              
#&gt; [17] "nested_country"             "ctg_country"               
#&gt; [19] "nested_Host"                "ctg_Host"                  
#&gt; [21] "nested_Host_latin"          "ctg_Host_latin"            
#&gt; [23] "nested_year"                "ctg_year"                  
#&gt; [25] "nested_continent"           "ctg_continent"             
#&gt; [27] "nested_Host_family"         "ctg_Host_family"           
#&gt; [29] "inNorway"                   "isWTE"                     
#&gt; [31] "category_highlight"</code></pre>
</div>
</section>
<section id="test-visualisation" class="level3">
<h3 class="anchored" data-anchor-id="test-visualisation">4. Test visualisation</h3>
<p>We can visualize which nodes can be collapsed and at which depths We can try to vary the depth of notes to be collapsed</p>
<div class="cell">
<pre><code>#&gt;  [1] "parent"                     "node"                      
#&gt;  [3] "branch.length"              "label"                     
#&gt;  [5] "isTip"                      "x"                         
#&gt;  [7] "y"                          "branch"                    
#&gt;  [9] "angle"                      "labels_bootstrap"          
#&gt; [11] "node_depth"                 "descendants_tips_from_node"
#&gt; [13] "isMono_noboot"              "isMono"                    
#&gt; [15] "edge_num"                   "tip_metalink"              
#&gt; [17] "nested_country"             "ctg_country"               
#&gt; [19] "nested_Host"                "ctg_Host"                  
#&gt; [21] "nested_Host_latin"          "ctg_Host_latin"            
#&gt; [23] "nested_year"                "ctg_year"                  
#&gt; [25] "nested_continent"           "ctg_continent"             
#&gt; [27] "nested_Host_family"         "ctg_Host_family"           
#&gt; [29] "inNorway"                   "isWTE"                     
#&gt; [31] "category_highlight"</code></pre>
</div>
<p>We add the node labels so we can know which ones we can collapse afterwards</p>
<div class="cell">
<pre><code>#&gt; Warning: There were 84 warnings in `filter()`.
#&gt; The first warning was:
#&gt; ℹ In argument: `as.numeric(labels_bootstrap) &gt;= 95`.
#&gt; ℹ In row 1.
#&gt; Caused by warning:
#&gt; ! NAs introduced by coercion
#&gt; ℹ Run `dplyr::last_dplyr_warnings()` to see the 83 remaining warnings.</code></pre>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SEP_H5N5_HA_phylogenetic_tree_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>ok here we see clearily that there is no large group to collapse to make it worsewhile</p>
</blockquote>
<div class="cell">
<pre><code>#&gt; Warning: There were 84 warnings in `filter()`.
#&gt; The first warning was:
#&gt; ℹ In argument: `as.numeric(labels_bootstrap) &gt;= 95`.
#&gt; ℹ In row 1.
#&gt; Caused by warning:
#&gt; ! NAs introduced by coercion
#&gt; ℹ Run `dplyr::last_dplyr_warnings()` to see the 83 remaining warnings.</code></pre>
</div>
</section>
</section>
</section>
<section id="components-for-final-visualisation" class="level1">
<h1>Components for final visualisation</h1>
<p>We will create the global circular tree And the two groups where White-tailed eagle are found to create trees that can be looked at more in detail.</p>
</section>
<section id="circular-tree" class="level1">
<h1>Circular tree</h1>
<p>We restart from the rooted tree with node labels</p>
<p>Circular metadata will be the at the last plots, except we do not add the coordinates</p>
<p>We had some plotting parameters to be able to view better</p>
<ul>
<li>Adding annotation around the tree <!-- here they wanted by country not by group of country --></li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SEP_H5N5_HA_phylogenetic_tree_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><em>Figure caption:</em> H5N5 HA segment. ML phylogenetic tree. The tree is rooted, but the outgroup is not shown, due to large distance to the body of the tree.</p>
<section id="rectangular-plot" class="level2">
<h2 class="anchored" data-anchor-id="rectangular-plot">Rectangular plot</h2>
<ul>
<li>preparing the data for the pannels views</li>
</ul>
<ul>
<li>ploting the tree</li>
</ul>
<div class="cell">
<pre><code>#&gt; The min value of positional variable is 0.0004974486 and the max value is 0.0106837522.
#&gt;  
#&gt;                   This should help you choose spacing values
#&gt; You have a maximum of 1 sequences positions for your unnested variable
#&gt; The min value of positional variable is 0.0004974486 and the max value is 0.0106837522.
#&gt;  
#&gt;                   This should help you choose spacing values
#&gt; You have a maximum of 1 sequences positions for your unnested variable
#&gt; The min value of positional variable is 0.0004974486 and the max value is 0.0106837522.
#&gt;  
#&gt;                   This should help you choose spacing values
#&gt; You have a maximum of 1 sequences positions for your unnested variable
#&gt; The min value of positional variable is 0.0004974486 and the max value is 0.0106837522.
#&gt;  
#&gt;                   This should help you choose spacing values
#&gt; You have a maximum of 1 sequences positions for your unnested variable</code></pre>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SEP_H5N5_HA_phylogenetic_tree_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>Now we need to adjust the size of the panels</li>
</ul>
<div class="cell">
<pre><code>#&gt; The min value of positional variable is 0.0004974486 and the max value is 0.0106837522.
#&gt;  
#&gt;                   This should help you choose spacing values
#&gt; You have a maximum of 1 sequences positions for your unnested variable</code></pre>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SEP_H5N5_HA_phylogenetic_tree_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><em>Figure Caption:</em> H5N5 HA segment. ML phylogenetic tree. The tree is rooted but the root is not shown as it is too distant from the rest of the tree.</p>
</section>
</section>
<section id="saving-environment" class="level1">
<h1>Saving environment</h1>
<p>To continue analyses that are not finished</p>
<p>Metadata for all H5N5 HA segment isolates included</p>
<p>This dataset is representative for 85 isolates. This includes 85 isolates with unique sequences, including 1 sequence as outgroup.</p>
<p>Some isolates have been submited to GISAID since we started this analysis, therefore the complement of GISAID_ID will be completed manually.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>